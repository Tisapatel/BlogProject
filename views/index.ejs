<%- include("partials/header") %>

  <section class="py-5 text-center">
    <div class="container">
      <span class="badge bg-light text-dark mb-2">Blog</span>
      <h1 class="fw-bold">Discover our latest news</h1>
      <p class="text-muted mb-4">Discover the achievements that set us apart...</p>

      <!-- Search Input -->
      <div class="d-flex justify-content-center mb-4">
        <input id="searchInput" type="text" class="form-control w-50 me-2" placeholder="Search blogs...">
        <button id="searchBtn" class="btn btn-primary">Find Now</button>
      </div>

      <!-- Search Results -->
      <div id="searchResults" class="mt-4"></div>
    </div>

    <!-- Latest Blogs -->
    <div class="container my-5">
      <h2 class="mb-4 fw-bold">Latest Blogs</h2>

      <div class="row g-4">
        <% if (blogs && blogs.length> 0) { %>
          <% blogs.forEach(blog=> { %>
            <div class="col-md-4">
              <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden position-relative">

                <!-- Blog Image -->
                <% if (blog.image) { %>
                  <img src="<%= blog.image %>" class="card-img-top" alt="Blog Image"
                    style="height:220px;object-fit:cover;">
                  <% } %>

                    <div class="card-body d-flex flex-column">
                      <!-- Profile + Date -->
                      <div class="d-flex align-items-center mb-3">
                        <img src="<%= blog.authorImage || '/images/default-user.png' %>" class="rounded-circle me-2"
                          width="40" height="40" alt="User">
                        <div>
                          <h6 class="mb-0 fw-semibold">
                            <%= blog.authorName || '' %>
                          </h6>
                          <small class="text-muted">
                            <%= blog.createdAt ? new Date(blog.createdAt).toLocaleDateString() : '' %>
                          </small>
                        </div>
                      </div>

                      <!-- Blog Title + Content -->
                      <h5 class="fw-bold">
                        <%= blog.title %>
                      </h5>
                      <p class="text-muted flex-grow-1">
                        <%= blog.content ? blog.content.substring(0, 120) : '' %>...
                      </p>

                      <!-- Read More -->
                      <a href="/blog/<%= blog._id %>" class="btn btn-outline-primary btn-sm mt-2">Read More</a>
                    </div>

                    <!-- Like / Comment -->
                    <div class="d-flex justify-content-around py-2 border-top bg-light">
                      <form action="/blog/<%= blog._id %>/like" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-light btn-sm">
                          <i class="bi bi-heart"></i> Like
                        </button>
                      </form>

                      <button class="btn btn-light btn-sm" data-bs-toggle="collapse"
                        data-bs-target="#comments-<%= blog._id %>">
                        <i class="bi bi-chat"></i> Comment
                    </div>



                    <!-- Comments Section -->
                    <div class="collapse" id="comments-<%= blog._id %>">
                      <div class="p-3">
                        <% if (blog.comments && blog.comments.length> 0) { %>
                          <% blog.comments.forEach(comment=> { %>
                            <div class="d-flex mb-2">
                              <img src="/images/default-user.png" width="30" height="30" class="rounded-circle me-2">
                              <div>
                                <strong>
                                  <%= comment.user %>
                                </strong>
                                <p class="mb-1">
                                  <%= comment.text %>
                                </p>
                                <small class="text-muted">
                                  <%= comment.createdAt ? new Date(comment.createdAt).toLocaleString() : '' %>
                                </small>
                              </div>
                            </div>
                            <% }) %>
                              <% } else { %>
                                <p class="text-muted">No comments yet.</p>
                                <% } %>

                                  <!-- Add new comment -->
                                  <form action="/blog/<%= blog._id %>/comment" method="POST" class="mt-2">
                                    <div class="input-group">
                                      <input type="text" name="text" class="form-control"
                                        placeholder="Write a comment..." required>
                                      <button class="btn btn-primary btn-sm" type="submit">Post</button>
                                    </div>
                                  </form>
                      </div>
                    </div>

              </div>
            </div>
            <% }) %>
              <% } else { %>
                <p>No blogs yet. <a href="/blog/add">Add one</a></p>
                <% } %>
      </div>
    </div>
  </section>

  <%- include("partials/footer") %>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Search Script -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const searchBtn = document.getElementById("searchBtn");
        const searchInput = document.getElementById("searchInput");
        const searchResults = document.getElementById("searchResults");

        searchBtn.addEventListener("click", async () => {
          const query = searchInput.value.trim();
          if (!query) return alert("Please enter a search term!");

          try {
            const res = await fetch(`/blog/search?query=${encodeURIComponent(query)}`);
            const data = await res.json();

            if (!data || data.length === 0) {
              searchResults.innerHTML = `<p class="text-muted">No blogs found.</p>`;
              return;
            }

            searchResults.innerHTML = data
              .map(blog => `
          <div class="card mb-3 text-start">
            <div class="card-body">
              <h5 class="card-title">${blog.title}</h5>
              <p class="card-text">${blog.content.substring(0, 100)}...</p>
              <a href="/blog/${blog._id}" class="btn btn-sm btn-outline-primary">Read More</a>
            </div>
          </div>
        `)
              .join("");
          } catch (err) {
            console.error(err);
            searchResults.innerHTML = `<p class="text-danger">Error fetching blogs.</p>`;
          }
        });
      });
    </script>